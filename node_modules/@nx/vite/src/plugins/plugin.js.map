{"version":3,"sources":["../../../../../packages/vite/src/plugins/plugin.ts"],"sourcesContent":["import {\n  CreateDependencies,\n  CreateNodes,\n  CreateNodesContext,\n  CreateNodesContextV2,\n  createNodesFromFiles,\n  CreateNodesV2,\n  detectPackageManager,\n  getPackageManagerCommand,\n  joinPathFragments,\n  logger,\n  ProjectConfiguration,\n  readJsonFile,\n  TargetConfiguration,\n  writeJsonFile,\n} from '@nx/devkit';\nimport { dirname, isAbsolute, join, relative } from 'path';\nimport { getNamedInputs } from '@nx/devkit/src/utils/get-named-inputs';\nimport { existsSync, readdirSync } from 'fs';\nimport {\n  calculateHashesForCreateNodes,\n  calculateHashForCreateNodes,\n} from '@nx/devkit/src/utils/calculate-hash-for-create-nodes';\nimport { workspaceDataDirectory } from 'nx/src/utils/cache-directory';\nimport { getLockFileName } from '@nx/js';\nimport { loadViteDynamicImport } from '../utils/executor-utils';\nimport { hashObject } from 'nx/src/hasher/file-hasher';\nimport { minimatch } from 'minimatch';\nimport { isUsingTsSolutionSetup as _isUsingTsSolutionSetup } from '@nx/js/src/utils/typescript/ts-solution-setup';\nimport { addBuildAndWatchDepsTargets } from '@nx/js/src/plugins/typescript/util';\n\nconst pmc = getPackageManagerCommand();\n\nexport interface VitePluginOptions {\n  buildTargetName?: string;\n  testTargetName?: string;\n  /**\n   * @deprecated Use devTargetName instead. This option will be removed in Nx 22.\n   */\n  serveTargetName?: string;\n  devTargetName?: string;\n  previewTargetName?: string;\n  serveStaticTargetName?: string;\n  typecheckTargetName?: string;\n  watchDepsTargetName?: string;\n  buildDepsTargetName?: string;\n}\n\ntype ViteTargets = Pick<\n  ProjectConfiguration,\n  'targets' | 'metadata' | 'projectType'\n>;\n\nfunction readTargetsCache(cachePath: string): Record<string, ViteTargets> {\n  return process.env.NX_CACHE_PROJECT_GRAPH !== 'false' && existsSync(cachePath)\n    ? readJsonFile(cachePath)\n    : {};\n}\n\nfunction writeTargetsToCache(cachePath, results?: Record<string, ViteTargets>) {\n  writeJsonFile(cachePath, results);\n}\n\n/**\n * @deprecated The 'createDependencies' function is now a no-op. This functionality is included in 'createNodesV2'.\n */\nexport const createDependencies: CreateDependencies = () => {\n  return [];\n};\n\nconst viteVitestConfigGlob = '**/{vite,vitest}.config.{js,ts,mjs,mts,cjs,cts}';\n\nexport const createNodesV2: CreateNodesV2<VitePluginOptions> = [\n  viteVitestConfigGlob,\n  async (configFilePaths, options, context) => {\n    const optionsHash = hashObject(options);\n    const normalizedOptions = normalizeOptions(options);\n    const cachePath = join(workspaceDataDirectory, `vite-${optionsHash}.hash`);\n    const targetsCache = readTargetsCache(cachePath);\n    const isUsingTsSolutionSetup = _isUsingTsSolutionSetup();\n\n    const { roots: projectRoots, configFiles: validConfigFiles } =\n      configFilePaths.reduce(\n        (acc, configFile) => {\n          const potentialRoot = dirname(configFile);\n          if (checkIfConfigFileShouldBeProject(potentialRoot, context)) {\n            acc.roots.push(potentialRoot);\n            acc.configFiles.push(configFile);\n          }\n          return acc;\n        },\n        {\n          roots: [],\n          configFiles: [],\n        } as {\n          roots: string[];\n          configFiles: string[];\n        }\n      );\n\n    const lockfile = getLockFileName(\n      detectPackageManager(context.workspaceRoot)\n    );\n    const hashes = await calculateHashesForCreateNodes(\n      projectRoots,\n      { ...normalizedOptions, isUsingTsSolutionSetup },\n      context,\n      projectRoots.map((r) => [lockfile])\n    );\n\n    try {\n      return await createNodesFromFiles(\n        async (configFile, _, context, idx) => {\n          const projectRoot = dirname(configFile);\n          // Do not create a project if package.json and project.json isn't there.\n          const siblingFiles = readdirSync(\n            join(context.workspaceRoot, projectRoot)\n          );\n\n          const tsConfigFiles =\n            siblingFiles.filter((p) =>\n              minimatch(p, 'tsconfig*{.json,.*.json}')\n            ) ?? [];\n\n          // results from vitest.config.js will be different from results of vite.config.js\n          // but the hash will be the same because it is based on the files under the project root.\n          // Adding the config file path to the hash ensures that the final hash value is different\n          // for different config files.\n          const hash = hashes[idx] + configFile;\n          const { projectType, metadata, targets } = (targetsCache[hash] ??=\n            await buildViteTargets(\n              configFile,\n              projectRoot,\n              normalizedOptions,\n              tsConfigFiles,\n              isUsingTsSolutionSetup,\n              context\n            ));\n\n          const project: ProjectConfiguration = {\n            root: projectRoot,\n            targets,\n            metadata,\n          };\n\n          // If project is buildable, then the project type.\n          // If it is not buildable, then leave it to other plugins/project.json to set the project type.\n          if (project.targets[normalizedOptions.buildTargetName]) {\n            project.projectType = projectType;\n          }\n\n          return {\n            projects: {\n              [projectRoot]: project,\n            },\n          };\n        },\n        validConfigFiles,\n        options,\n        context\n      );\n    } finally {\n      writeTargetsToCache(cachePath, targetsCache);\n    }\n  },\n];\n\nexport const createNodes: CreateNodes<VitePluginOptions> = [\n  viteVitestConfigGlob,\n  async (configFilePath, options, context) => {\n    logger.warn(\n      '`createNodes` is deprecated. Update your plugin to utilize createNodesV2 instead. In Nx 20, this will change to the createNodesV2 API.'\n    );\n    const projectRoot = dirname(configFilePath);\n    // Do not create a project if package.json and project.json isn't there.\n    const siblingFiles = readdirSync(join(context.workspaceRoot, projectRoot));\n    if (\n      !siblingFiles.includes('package.json') &&\n      !siblingFiles.includes('project.json')\n    ) {\n      return {};\n    }\n\n    const tsConfigFiles =\n      siblingFiles.filter((p) => minimatch(p, 'tsconfig*{.json,.*.json}')) ??\n      [];\n\n    const normalizedOptions = normalizeOptions(options);\n\n    const isUsingTsSolutionSetup = _isUsingTsSolutionSetup();\n\n    const { projectType, metadata, targets } = await buildViteTargets(\n      configFilePath,\n      projectRoot,\n      normalizedOptions,\n      tsConfigFiles,\n      isUsingTsSolutionSetup,\n      context\n    );\n    const project: ProjectConfiguration = {\n      root: projectRoot,\n      targets,\n      metadata,\n    };\n\n    // If project is buildable, then the project type.\n    // If it is not buildable, then leave it to other plugins/project.json to set the project type.\n    if (project.targets[normalizedOptions.buildTargetName]) {\n      project.projectType = projectType;\n    }\n\n    return {\n      projects: {\n        [projectRoot]: project,\n      },\n    };\n  },\n];\n\nasync function buildViteTargets(\n  configFilePath: string,\n  projectRoot: string,\n  options: VitePluginOptions,\n  tsConfigFiles: string[],\n  isUsingTsSolutionSetup: boolean,\n  context: CreateNodesContext\n): Promise<ViteTargets> {\n  const absoluteConfigFilePath = joinPathFragments(\n    context.workspaceRoot,\n    configFilePath\n  );\n  // Workaround for the `build$3 is not a function` error that we sometimes see in agents.\n  // This should be removed later once we address the issue properly\n  try {\n    const importEsbuild = () => new Function('return import(\"esbuild\")')();\n    await importEsbuild();\n  } catch {\n    // do nothing\n  }\n  const { resolveConfig } = await loadViteDynamicImport();\n  const viteBuildConfig = await resolveConfig(\n    {\n      configFile: absoluteConfigFilePath,\n      mode: 'development',\n    },\n    'build'\n  );\n\n  const { buildOutputs, testOutputs, hasTest, isBuildable, hasServeConfig } =\n    getOutputs(viteBuildConfig, projectRoot, context.workspaceRoot);\n\n  const namedInputs = getNamedInputs(projectRoot, context);\n\n  const targets: Record<string, TargetConfiguration> = {};\n\n  // If file is not vitest.config and buildable, create targets for build, serve, preview and serve-static\n  const hasRemixPlugin =\n    viteBuildConfig.plugins &&\n    viteBuildConfig.plugins.some((p) => p.name === 'remix');\n  if (\n    !configFilePath.includes('vitest.config') &&\n    !hasRemixPlugin &&\n    isBuildable\n  ) {\n    targets[options.buildTargetName] = await buildTarget(\n      options.buildTargetName,\n      namedInputs,\n      buildOutputs,\n      projectRoot,\n      isUsingTsSolutionSetup\n    );\n\n    // If running in library mode, then there is nothing to serve.\n    if (!viteBuildConfig.build?.lib || hasServeConfig) {\n      const devTarget = serveTarget(projectRoot, isUsingTsSolutionSetup);\n\n      targets[options.serveTargetName] = {\n        ...devTarget,\n        metadata: {\n          ...devTarget.metadata,\n          deprecated:\n            'Use devTargetName instead. This option will be removed in Nx 22.',\n        },\n      };\n      targets[options.devTargetName] = devTarget;\n      targets[options.previewTargetName] = previewTarget(\n        projectRoot,\n        options.buildTargetName\n      );\n      targets[options.serveStaticTargetName] = serveStaticTarget(\n        options,\n        isUsingTsSolutionSetup\n      );\n    }\n  }\n\n  if (tsConfigFiles.length) {\n    const tsConfigToUse =\n      ['tsconfig.app.json', 'tsconfig.lib.json', 'tsconfig.json'].find((t) =>\n        tsConfigFiles.includes(t)\n      ) ?? tsConfigFiles[0];\n    targets[options.typecheckTargetName] = {\n      cache: true,\n      inputs: [\n        ...('production' in namedInputs\n          ? ['production', '^production']\n          : ['default', '^default']),\n        { externalDependencies: ['typescript'] },\n      ],\n      command: isUsingTsSolutionSetup\n        ? `tsc --build --emitDeclarationOnly`\n        : `tsc --noEmit -p ${tsConfigToUse}`,\n      options: { cwd: joinPathFragments(projectRoot) },\n      metadata: {\n        description: `Runs type-checking for the project.`,\n        technologies: ['typescript'],\n        help: {\n          command: isUsingTsSolutionSetup\n            ? `${pmc.exec} tsc --build --help`\n            : `${pmc.exec} tsc -p ${tsConfigToUse} --help`,\n          example: isUsingTsSolutionSetup\n            ? { args: ['--force'] }\n            : { options: { noEmit: true } },\n        },\n      },\n    };\n\n    if (isUsingTsSolutionSetup) {\n      targets[options.typecheckTargetName].dependsOn = [\n        `^${options.typecheckTargetName}`,\n      ];\n      targets[options.typecheckTargetName].syncGenerators = [\n        '@nx/js:typescript-sync',\n      ];\n    }\n  }\n\n  // if file is vitest.config or vite.config has definition for test, create target for test\n  if (configFilePath.includes('vitest.config') || hasTest) {\n    targets[options.testTargetName] = await testTarget(\n      namedInputs,\n      testOutputs,\n      projectRoot\n    );\n  }\n\n  addBuildAndWatchDepsTargets(\n    context.workspaceRoot,\n    projectRoot,\n    targets,\n    options,\n    pmc\n  );\n\n  const metadata = {};\n  return {\n    targets,\n    metadata,\n    projectType: viteBuildConfig.build?.lib ? 'library' : 'application',\n  };\n}\n\nasync function buildTarget(\n  buildTargetName: string,\n  namedInputs: {\n    [inputName: string]: any[];\n  },\n  outputs: string[],\n  projectRoot: string,\n  isUsingTsSolutionSetup: boolean\n) {\n  const buildTarget: TargetConfiguration = {\n    command: `vite build`,\n    options: { cwd: joinPathFragments(projectRoot) },\n    cache: true,\n    dependsOn: [`^${buildTargetName}`],\n    inputs: [\n      ...('production' in namedInputs\n        ? ['production', '^production']\n        : ['default', '^default']),\n      {\n        externalDependencies: ['vite'],\n      },\n    ],\n    outputs,\n    metadata: {\n      technologies: ['vite'],\n      description: `Run Vite build`,\n      help: {\n        command: `${pmc.exec} vite build --help`,\n        example: {\n          options: {\n            sourcemap: true,\n            manifest: 'manifest.json',\n          },\n        },\n      },\n    },\n  };\n\n  if (isUsingTsSolutionSetup) {\n    buildTarget.syncGenerators = ['@nx/js:typescript-sync'];\n  }\n\n  return buildTarget;\n}\n\nfunction serveTarget(projectRoot: string, isUsingTsSolutionSetup: boolean) {\n  const targetConfig: TargetConfiguration = {\n    command: `vite`,\n    options: {\n      cwd: joinPathFragments(projectRoot),\n    },\n    metadata: {\n      technologies: ['vite'],\n      description: `Starts Vite dev server`,\n      help: {\n        command: `${pmc.exec} vite --help`,\n        example: {\n          options: {\n            port: 3000,\n          },\n        },\n      },\n    },\n  };\n\n  if (isUsingTsSolutionSetup) {\n    targetConfig.syncGenerators = ['@nx/js:typescript-sync'];\n  }\n\n  return targetConfig;\n}\n\nfunction previewTarget(projectRoot: string, buildTargetName) {\n  const targetConfig: TargetConfiguration = {\n    command: `vite preview`,\n    dependsOn: [buildTargetName],\n    options: {\n      cwd: joinPathFragments(projectRoot),\n    },\n    metadata: {\n      technologies: ['vite'],\n      description: `Locally preview Vite production build`,\n      help: {\n        command: `${pmc.exec} vite preview --help`,\n        example: {\n          options: {\n            port: 3000,\n          },\n        },\n      },\n    },\n  };\n\n  return targetConfig;\n}\n\nasync function testTarget(\n  namedInputs: {\n    [inputName: string]: any[];\n  },\n  outputs: string[],\n  projectRoot: string\n) {\n  return {\n    command: `vitest`,\n    options: { cwd: joinPathFragments(projectRoot) },\n    cache: true,\n    inputs: [\n      ...('production' in namedInputs\n        ? ['default', '^production']\n        : ['default', '^default']),\n      {\n        externalDependencies: ['vitest'],\n      },\n      { env: 'CI' },\n    ],\n    outputs,\n    metadata: {\n      technologies: ['vite'],\n      description: `Run Vite tests`,\n      help: {\n        command: `${pmc.exec} vitest --help`,\n        example: {\n          options: {\n            bail: 1,\n            coverage: true,\n          },\n        },\n      },\n    },\n  };\n}\n\nfunction serveStaticTarget(\n  options: VitePluginOptions,\n  isUsingTsSolutionSetup: boolean\n) {\n  const targetConfig: TargetConfiguration = {\n    executor: '@nx/web:file-server',\n    options: {\n      buildTarget: `${options.buildTargetName}`,\n      spa: true,\n    },\n  };\n\n  if (isUsingTsSolutionSetup) {\n    targetConfig.syncGenerators = ['@nx/js:typescript-sync'];\n  }\n\n  return targetConfig;\n}\n\nfunction getOutputs(\n  viteBuildConfig: Record<string, any> | undefined,\n  projectRoot: string,\n  workspaceRoot: string\n): {\n  buildOutputs: string[];\n  testOutputs: string[];\n  hasTest: boolean;\n  isBuildable: boolean;\n  hasServeConfig: boolean;\n} {\n  const { build, test, server } = viteBuildConfig;\n\n  const buildOutputPath = normalizeOutputPath(\n    build?.outDir,\n    projectRoot,\n    workspaceRoot,\n    'dist'\n  );\n\n  const isBuildable =\n    build?.lib ||\n    build?.rollupOptions?.input ||\n    existsSync(join(workspaceRoot, projectRoot, 'index.html'));\n\n  const hasServeConfig = Boolean(server);\n\n  const reportsDirectoryPath = normalizeOutputPath(\n    test?.coverage?.reportsDirectory,\n    projectRoot,\n    workspaceRoot,\n    'coverage'\n  );\n\n  return {\n    buildOutputs: [buildOutputPath],\n    testOutputs: [reportsDirectoryPath],\n    hasTest: !!test,\n    isBuildable,\n    hasServeConfig,\n  };\n}\n\nfunction normalizeOutputPath(\n  outputPath: string | undefined,\n  projectRoot: string,\n  workspaceRoot: string,\n  path: 'coverage' | 'dist'\n): string | undefined {\n  if (!outputPath) {\n    if (projectRoot === '.') {\n      return `{projectRoot}/${path}`;\n    } else {\n      return `{workspaceRoot}/${path}/{projectRoot}`;\n    }\n  } else {\n    if (isAbsolute(outputPath)) {\n      return `{workspaceRoot}/${relative(workspaceRoot, outputPath)}`;\n    } else {\n      if (outputPath.startsWith('..')) {\n        return join('{workspaceRoot}', join(projectRoot, outputPath));\n      } else {\n        return join('{projectRoot}', outputPath);\n      }\n    }\n  }\n}\n\nfunction normalizeOptions(options: VitePluginOptions): VitePluginOptions {\n  options ??= {};\n  options.buildTargetName ??= 'build';\n  options.serveTargetName ??= 'serve';\n  options.devTargetName ??= 'dev';\n  options.previewTargetName ??= 'preview';\n  options.testTargetName ??= 'test';\n  options.serveStaticTargetName ??= 'serve-static';\n  options.typecheckTargetName ??= 'typecheck';\n  return options;\n}\n\nfunction checkIfConfigFileShouldBeProject(\n  projectRoot: string,\n  context: CreateNodesContext | CreateNodesContextV2\n): boolean {\n  // Do not create a project if package.json and project.json isn't there.\n  const siblingFiles = readdirSync(join(context.workspaceRoot, projectRoot));\n  if (\n    !siblingFiles.includes('package.json') &&\n    !siblingFiles.includes('project.json')\n  ) {\n    return false;\n  }\n\n  return true;\n}\n"],"names":["createDependencies","createNodes","createNodesV2","pmc","getPackageManagerCommand","readTargetsCache","cachePath","process","env","NX_CACHE_PROJECT_GRAPH","existsSync","readJsonFile","writeTargetsToCache","results","writeJsonFile","viteVitestConfigGlob","configFilePaths","options","context","optionsHash","hashObject","normalizedOptions","normalizeOptions","join","workspaceDataDirectory","targetsCache","isUsingTsSolutionSetup","_isUsingTsSolutionSetup","roots","projectRoots","configFiles","validConfigFiles","reduce","acc","configFile","potentialRoot","dirname","checkIfConfigFileShouldBeProject","push","lockfile","getLockFileName","detectPackageManager","workspaceRoot","hashes","calculateHashesForCreateNodes","map","r","createNodesFromFiles","_","idx","hash","projectRoot","siblingFiles","readdirSync","tsConfigFiles","filter","p","minimatch","projectType","metadata","targets","buildViteTargets","project","root","buildTargetName","projects","configFilePath","logger","warn","includes","viteBuildConfig","absoluteConfigFilePath","joinPathFragments","importEsbuild","Function","resolveConfig","loadViteDynamicImport","mode","buildOutputs","testOutputs","hasTest","isBuildable","hasServeConfig","getOutputs","namedInputs","getNamedInputs","hasRemixPlugin","plugins","some","name","buildTarget","build","lib","devTarget","serveTarget","serveTargetName","deprecated","devTargetName","previewTargetName","previewTarget","serveStaticTargetName","serveStaticTarget","length","tsConfigToUse","find","t","typecheckTargetName","cache","inputs","externalDependencies","command","cwd","description","technologies","help","exec","example","args","noEmit","dependsOn","syncGenerators","testTargetName","testTarget","addBuildAndWatchDepsTargets","outputs","sourcemap","manifest","targetConfig","port","bail","coverage","executor","spa","test","server","buildOutputPath","normalizeOutputPath","outDir","rollupOptions","input","Boolean","reportsDirectoryPath","reportsDirectory","outputPath","path","isAbsolute","relative","startsWith"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;;;;;IAkEaA,kBAAkB;eAAlBA;;IAqGAC,WAAW;eAAXA;;IA/FAC,aAAa;eAAbA;;;;wBAzDN;sBAC6C;gCACrB;oBACS;6CAIjC;gCACgC;oBACP;+BACM;4BACX;2BACD;iCACwC;sBACtB;AAE5C,MAAMC,MAAMC,IAAAA,gCAAwB;AAsBpC,SAASC,iBAAiBC,SAAiB;IACzC,OAAOC,QAAQC,GAAG,CAACC,sBAAsB,KAAK,WAAWC,IAAAA,cAAU,EAACJ,aAChEK,IAAAA,oBAAY,EAACL,aACb,CAAC;AACP;AAEA,SAASM,oBAAoBN,SAAS,EAAEO,OAAqC;IAC3EC,IAAAA,qBAAa,EAACR,WAAWO;AAC3B;AAKO,MAAMb,qBAAyC;IACpD,OAAO,EAAE;AACX;AAEA,MAAMe,uBAAuB;AAEtB,MAAMb,gBAAkD;IAC7Da;IACA,OAAOC,iBAAiBC,SAASC;QAC/B,MAAMC,cAAcC,IAAAA,sBAAU,EAACH;QAC/B,MAAMI,oBAAoBC,iBAAiBL;QAC3C,MAAMX,YAAYiB,IAAAA,UAAI,EAACC,sCAAsB,EAAE,CAAC,KAAK,EAAEL,YAAY,KAAK,CAAC;QACzE,MAAMM,eAAepB,iBAAiBC;QACtC,MAAMoB,yBAAyBC,IAAAA,uCAAuB;QAEtD,MAAM,EAAEC,OAAOC,YAAY,EAAEC,aAAaC,gBAAgB,EAAE,GAC1Df,gBAAgBgB,MAAM,CACpB,CAACC,KAAKC;YACJ,MAAMC,gBAAgBC,IAAAA,aAAO,EAACF;YAC9B,IAAIG,iCAAiCF,eAAejB,UAAU;gBAC5De,IAAIL,KAAK,CAACU,IAAI,CAACH;gBACfF,IAAIH,WAAW,CAACQ,IAAI,CAACJ;YACvB;YACA,OAAOD;QACT,GACA;YACEL,OAAO,EAAE;YACTE,aAAa,EAAE;QACjB;QAMJ,MAAMS,WAAWC,IAAAA,mBAAe,EAC9BC,IAAAA,4BAAoB,EAACvB,QAAQwB,aAAa;QAE5C,MAAMC,SAAS,MAAMC,IAAAA,0DAA6B,EAChDf,cACA,eAAKR;YAAmBK;YACxBR,SACAW,aAAagB,GAAG,CAAC,CAACC,IAAM;gBAACP;aAAS;QAGpC,IAAI;YACF,OAAO,MAAMQ,IAAAA,4BAAoB,EAC/B,OAAOb,YAAYc,GAAG9B,SAAS+B;oBAiBexB,eAAayB;gBAhBzD,MAAMC,cAAcf,IAAAA,aAAO,EAACF;gBAC5B,wEAAwE;gBACxE,MAAMkB,eAAeC,IAAAA,eAAW,EAC9B9B,IAAAA,UAAI,EAACL,QAAQwB,aAAa,EAAES;oBAI5BC;gBADF,MAAME,gBACJF,CAAAA,uBAAAA,aAAaG,MAAM,CAAC,CAACC,IACnBC,IAAAA,oBAAS,EAACD,GAAG,wCADfJ,uBAEK,EAAE;gBAET,iFAAiF;gBACjF,yFAAyF;gBACzF,yFAAyF;gBACzF,8BAA8B;gBAC9B,MAAMF,OAAOP,MAAM,CAACM,IAAI,GAAGf;;gBAC3B,MAAM,EAAEwB,WAAW,EAAEC,QAAQ,EAAEC,OAAO,EAAE,GAAInC,OAAAA,gBAAAA,aAAY,CAACyB,QAAAA,KAAK,iBAAlBzB,aAAY,CAACyB,MAAK,GAC5D,MAAMW,iBACJ3B,YACAiB,aACA9B,mBACAiC,eACA5B,wBACAR;gBAGJ,MAAM4C,UAAgC;oBACpCC,MAAMZ;oBACNS;oBACAD;gBACF;gBAEA,kDAAkD;gBAClD,+FAA+F;gBAC/F,IAAIG,QAAQF,OAAO,CAACvC,kBAAkB2C,eAAe,CAAC,EAAE;oBACtDF,QAAQJ,WAAW,GAAGA;gBACxB;gBAEA,OAAO;oBACLO,UAAU;wBACR,CAACd,YAAY,EAAEW;oBACjB;gBACF;YACF,GACA/B,kBACAd,SACAC;QAEJ,SAAU;YACRN,oBAAoBN,WAAWmB;QACjC;IACF;CACD;AAEM,MAAMxB,cAA8C;IACzDc;IACA,OAAOmD,gBAAgBjD,SAASC;QAC9BiD,cAAM,CAACC,IAAI,CACT;QAEF,MAAMjB,cAAcf,IAAAA,aAAO,EAAC8B;QAC5B,wEAAwE;QACxE,MAAMd,eAAeC,IAAAA,eAAW,EAAC9B,IAAAA,UAAI,EAACL,QAAQwB,aAAa,EAAES;QAC7D,IACE,CAACC,aAAaiB,QAAQ,CAAC,mBACvB,CAACjB,aAAaiB,QAAQ,CAAC,iBACvB;YACA,OAAO,CAAC;QACV;YAGEjB;QADF,MAAME,gBACJF,CAAAA,uBAAAA,aAAaG,MAAM,CAAC,CAACC,IAAMC,IAAAA,oBAAS,EAACD,GAAG,wCAAxCJ,uBACA,EAAE;QAEJ,MAAM/B,oBAAoBC,iBAAiBL;QAE3C,MAAMS,yBAAyBC,IAAAA,uCAAuB;QAEtD,MAAM,EAAE+B,WAAW,EAAEC,QAAQ,EAAEC,OAAO,EAAE,GAAG,MAAMC,iBAC/CK,gBACAf,aACA9B,mBACAiC,eACA5B,wBACAR;QAEF,MAAM4C,UAAgC;YACpCC,MAAMZ;YACNS;YACAD;QACF;QAEA,kDAAkD;QAClD,+FAA+F;QAC/F,IAAIG,QAAQF,OAAO,CAACvC,kBAAkB2C,eAAe,CAAC,EAAE;YACtDF,QAAQJ,WAAW,GAAGA;QACxB;QAEA,OAAO;YACLO,UAAU;gBACR,CAACd,YAAY,EAAEW;YACjB;QACF;IACF;CACD;AAED,eAAeD,iBACbK,cAAsB,EACtBf,WAAmB,EACnBlC,OAA0B,EAC1BqC,aAAuB,EACvB5B,sBAA+B,EAC/BR,OAA2B;QAqIZoD;IAnIf,MAAMC,yBAAyBC,IAAAA,yBAAiB,EAC9CtD,QAAQwB,aAAa,EACrBwB;IAEF,wFAAwF;IACxF,kEAAkE;IAClE,IAAI;QACF,MAAMO,gBAAgB,IAAM,IAAIC,SAAS;QACzC,MAAMD;IACR,EAAE,UAAM;IACN,aAAa;IACf;IACA,MAAM,EAAEE,aAAa,EAAE,GAAG,MAAMC,IAAAA,oCAAqB;IACrD,MAAMN,kBAAkB,MAAMK,cAC5B;QACEzC,YAAYqC;QACZM,MAAM;IACR,GACA;IAGF,MAAM,EAAEC,YAAY,EAAEC,WAAW,EAAEC,OAAO,EAAEC,WAAW,EAAEC,cAAc,EAAE,GACvEC,WAAWb,iBAAiBnB,aAAajC,QAAQwB,aAAa;IAEhE,MAAM0C,cAAcC,IAAAA,8BAAc,EAAClC,aAAajC;IAEhD,MAAM0C,UAA+C,CAAC;IAEtD,wGAAwG;IACxG,MAAM0B,iBACJhB,gBAAgBiB,OAAO,IACvBjB,gBAAgBiB,OAAO,CAACC,IAAI,CAAC,CAAChC,IAAMA,EAAEiC,IAAI,KAAK;IACjD,IACE,CAACvB,eAAeG,QAAQ,CAAC,oBACzB,CAACiB,kBACDL,aACA;YAUKX;QATLV,OAAO,CAAC3C,QAAQ+C,eAAe,CAAC,GAAG,MAAM0B,YACvCzE,QAAQ+C,eAAe,EACvBoB,aACAN,cACA3B,aACAzB;QAGF,8DAA8D;QAC9D,IAAI,GAAC4C,0BAAAA,gBAAgBqB,KAAK,qBAArBrB,wBAAuBsB,GAAG,KAAIV,gBAAgB;YACjD,MAAMW,YAAYC,YAAY3C,aAAazB;YAE3CkC,OAAO,CAAC3C,QAAQ8E,eAAe,CAAC,GAAG,eAC9BF;gBACHlC,UAAU,eACLkC,UAAUlC,QAAQ;oBACrBqC,YACE;;;YAGNpC,OAAO,CAAC3C,QAAQgF,aAAa,CAAC,GAAGJ;YACjCjC,OAAO,CAAC3C,QAAQiF,iBAAiB,CAAC,GAAGC,cACnChD,aACAlC,QAAQ+C,eAAe;YAEzBJ,OAAO,CAAC3C,QAAQmF,qBAAqB,CAAC,GAAGC,kBACvCpF,SACAS;QAEJ;IACF;IAEA,IAAI4B,cAAcgD,MAAM,EAAE;YAEtB;QADF,MAAMC,gBACJ,CAAA,QAAA;YAAC;YAAqB;YAAqB;SAAgB,CAACC,IAAI,CAAC,CAACC,IAChEnD,cAAce,QAAQ,CAACoC,eADzB,QAEKnD,aAAa,CAAC,EAAE;QACvBM,OAAO,CAAC3C,QAAQyF,mBAAmB,CAAC,GAAG;YACrCC,OAAO;YACPC,QAAQ;mBACF,gBAAgBxB,cAChB;oBAAC;oBAAc;iBAAc,GAC7B;oBAAC;oBAAW;iBAAW;gBAC3B;oBAAEyB,sBAAsB;wBAAC;qBAAa;gBAAC;aACxC;YACDC,SAASpF,yBACL,CAAC,iCAAiC,CAAC,GACnC,CAAC,gBAAgB,EAAE6E,cAAc,CAAC;YACtCtF,SAAS;gBAAE8F,KAAKvC,IAAAA,yBAAiB,EAACrB;YAAa;YAC/CQ,UAAU;gBACRqD,aAAa,CAAC,mCAAmC,CAAC;gBAClDC,cAAc;oBAAC;iBAAa;gBAC5BC,MAAM;oBACJJ,SAASpF,yBACL,CAAC,EAAEvB,IAAIgH,IAAI,CAAC,mBAAmB,CAAC,GAChC,CAAC,EAAEhH,IAAIgH,IAAI,CAAC,QAAQ,EAAEZ,cAAc,OAAO,CAAC;oBAChDa,SAAS1F,yBACL;wBAAE2F,MAAM;4BAAC;yBAAU;oBAAC,IACpB;wBAAEpG,SAAS;4BAAEqG,QAAQ;wBAAK;oBAAE;gBAClC;YACF;QACF;QAEA,IAAI5F,wBAAwB;YAC1BkC,OAAO,CAAC3C,QAAQyF,mBAAmB,CAAC,CAACa,SAAS,GAAG;gBAC/C,CAAC,CAAC,EAAEtG,QAAQyF,mBAAmB,CAAC,CAAC;aAClC;YACD9C,OAAO,CAAC3C,QAAQyF,mBAAmB,CAAC,CAACc,cAAc,GAAG;gBACpD;aACD;QACH;IACF;IAEA,0FAA0F;IAC1F,IAAItD,eAAeG,QAAQ,CAAC,oBAAoBW,SAAS;QACvDpB,OAAO,CAAC3C,QAAQwG,cAAc,CAAC,GAAG,MAAMC,WACtCtC,aACAL,aACA5B;IAEJ;IAEAwE,IAAAA,iCAA2B,EACzBzG,QAAQwB,aAAa,EACrBS,aACAS,SACA3C,SACAd;IAGF,MAAMwD,WAAW,CAAC;IAClB,OAAO;QACLC;QACAD;QACAD,aAAaY,EAAAA,yBAAAA,gBAAgBqB,KAAK,qBAArBrB,uBAAuBsB,GAAG,IAAG,YAAY;IACxD;AACF;AAEA,eAAeF,YACb1B,eAAuB,EACvBoB,WAEC,EACDwC,OAAiB,EACjBzE,WAAmB,EACnBzB,sBAA+B;IAE/B,MAAMgE,cAAmC;QACvCoB,SAAS,CAAC,UAAU,CAAC;QACrB7F,SAAS;YAAE8F,KAAKvC,IAAAA,yBAAiB,EAACrB;QAAa;QAC/CwD,OAAO;QACPY,WAAW;YAAC,CAAC,CAAC,EAAEvD,gBAAgB,CAAC;SAAC;QAClC4C,QAAQ;eACF,gBAAgBxB,cAChB;gBAAC;gBAAc;aAAc,GAC7B;gBAAC;gBAAW;aAAW;YAC3B;gBACEyB,sBAAsB;oBAAC;iBAAO;YAChC;SACD;QACDe;QACAjE,UAAU;YACRsD,cAAc;gBAAC;aAAO;YACtBD,aAAa,CAAC,cAAc,CAAC;YAC7BE,MAAM;gBACJJ,SAAS,CAAC,EAAE3G,IAAIgH,IAAI,CAAC,kBAAkB,CAAC;gBACxCC,SAAS;oBACPnG,SAAS;wBACP4G,WAAW;wBACXC,UAAU;oBACZ;gBACF;YACF;QACF;IACF;IAEA,IAAIpG,wBAAwB;QAC1BgE,YAAY8B,cAAc,GAAG;YAAC;SAAyB;IACzD;IAEA,OAAO9B;AACT;AAEA,SAASI,YAAY3C,WAAmB,EAAEzB,sBAA+B;IACvE,MAAMqG,eAAoC;QACxCjB,SAAS,CAAC,IAAI,CAAC;QACf7F,SAAS;YACP8F,KAAKvC,IAAAA,yBAAiB,EAACrB;QACzB;QACAQ,UAAU;YACRsD,cAAc;gBAAC;aAAO;YACtBD,aAAa,CAAC,sBAAsB,CAAC;YACrCE,MAAM;gBACJJ,SAAS,CAAC,EAAE3G,IAAIgH,IAAI,CAAC,YAAY,CAAC;gBAClCC,SAAS;oBACPnG,SAAS;wBACP+G,MAAM;oBACR;gBACF;YACF;QACF;IACF;IAEA,IAAItG,wBAAwB;QAC1BqG,aAAaP,cAAc,GAAG;YAAC;SAAyB;IAC1D;IAEA,OAAOO;AACT;AAEA,SAAS5B,cAAchD,WAAmB,EAAEa,eAAe;IACzD,MAAM+D,eAAoC;QACxCjB,SAAS,CAAC,YAAY,CAAC;QACvBS,WAAW;YAACvD;SAAgB;QAC5B/C,SAAS;YACP8F,KAAKvC,IAAAA,yBAAiB,EAACrB;QACzB;QACAQ,UAAU;YACRsD,cAAc;gBAAC;aAAO;YACtBD,aAAa,CAAC,qCAAqC,CAAC;YACpDE,MAAM;gBACJJ,SAAS,CAAC,EAAE3G,IAAIgH,IAAI,CAAC,oBAAoB,CAAC;gBAC1CC,SAAS;oBACPnG,SAAS;wBACP+G,MAAM;oBACR;gBACF;YACF;QACF;IACF;IAEA,OAAOD;AACT;AAEA,eAAeL,WACbtC,WAEC,EACDwC,OAAiB,EACjBzE,WAAmB;IAEnB,OAAO;QACL2D,SAAS,CAAC,MAAM,CAAC;QACjB7F,SAAS;YAAE8F,KAAKvC,IAAAA,yBAAiB,EAACrB;QAAa;QAC/CwD,OAAO;QACPC,QAAQ;eACF,gBAAgBxB,cAChB;gBAAC;gBAAW;aAAc,GAC1B;gBAAC;gBAAW;aAAW;YAC3B;gBACEyB,sBAAsB;oBAAC;iBAAS;YAClC;YACA;gBAAErG,KAAK;YAAK;SACb;QACDoH;QACAjE,UAAU;YACRsD,cAAc;gBAAC;aAAO;YACtBD,aAAa,CAAC,cAAc,CAAC;YAC7BE,MAAM;gBACJJ,SAAS,CAAC,EAAE3G,IAAIgH,IAAI,CAAC,cAAc,CAAC;gBACpCC,SAAS;oBACPnG,SAAS;wBACPgH,MAAM;wBACNC,UAAU;oBACZ;gBACF;YACF;QACF;IACF;AACF;AAEA,SAAS7B,kBACPpF,OAA0B,EAC1BS,sBAA+B;IAE/B,MAAMqG,eAAoC;QACxCI,UAAU;QACVlH,SAAS;YACPyE,aAAa,CAAC,EAAEzE,QAAQ+C,eAAe,CAAC,CAAC;YACzCoE,KAAK;QACP;IACF;IAEA,IAAI1G,wBAAwB;QAC1BqG,aAAaP,cAAc,GAAG;YAAC;SAAyB;IAC1D;IAEA,OAAOO;AACT;AAEA,SAAS5C,WACPb,eAAgD,EAChDnB,WAAmB,EACnBT,aAAqB;QAmBnBiD,sBAMA0C;IAjBF,MAAM,EAAE1C,KAAK,EAAE0C,IAAI,EAAEC,MAAM,EAAE,GAAGhE;IAEhC,MAAMiE,kBAAkBC,oBACtB7C,yBAAAA,MAAO8C,MAAM,EACbtF,aACAT,eACA;IAGF,MAAMuC,cACJU,CAAAA,yBAAAA,MAAOC,GAAG,MACVD,0BAAAA,uBAAAA,MAAO+C,aAAa,qBAApB/C,qBAAsBgD,KAAK,KAC3BjI,IAAAA,cAAU,EAACa,IAAAA,UAAI,EAACmB,eAAeS,aAAa;IAE9C,MAAM+B,iBAAiB0D,QAAQN;IAE/B,MAAMO,uBAAuBL,oBAC3BH,yBAAAA,iBAAAA,KAAMH,QAAQ,qBAAdG,eAAgBS,gBAAgB,EAChC3F,aACAT,eACA;IAGF,OAAO;QACLoC,cAAc;YAACyD;SAAgB;QAC/BxD,aAAa;YAAC8D;SAAqB;QACnC7D,SAAS,CAAC,CAACqD;QACXpD;QACAC;IACF;AACF;AAEA,SAASsD,oBACPO,UAA8B,EAC9B5F,WAAmB,EACnBT,aAAqB,EACrBsG,IAAyB;IAEzB,IAAI,CAACD,YAAY;QACf,IAAI5F,gBAAgB,KAAK;YACvB,OAAO,CAAC,cAAc,EAAE6F,KAAK,CAAC;QAChC,OAAO;YACL,OAAO,CAAC,gBAAgB,EAAEA,KAAK,cAAc,CAAC;QAChD;IACF,OAAO;QACL,IAAIC,IAAAA,gBAAU,EAACF,aAAa;YAC1B,OAAO,CAAC,gBAAgB,EAAEG,IAAAA,cAAQ,EAACxG,eAAeqG,YAAY,CAAC;QACjE,OAAO;YACL,IAAIA,WAAWI,UAAU,CAAC,OAAO;gBAC/B,OAAO5H,IAAAA,UAAI,EAAC,mBAAmBA,IAAAA,UAAI,EAAC4B,aAAa4F;YACnD,OAAO;gBACL,OAAOxH,IAAAA,UAAI,EAAC,iBAAiBwH;YAC/B;QACF;IACF;AACF;AAEA,SAASzH,iBAAiBL,OAA0B;QAElDA,UACAA,WACAA,WACAA,WACAA,WACAA,WACAA;IAPAA,kBAAAA,UAAAA,UAAY,CAAC;;IACbA,qBAAAA,WAAAA,SAAQ+C,8CAAR/C,SAAQ+C,kBAAoB;;IAC5B/C,qBAAAA,YAAAA,SAAQ8E,8CAAR9E,UAAQ8E,kBAAoB;;IAC5B9E,mBAAAA,YAAAA,SAAQgF,0CAARhF,UAAQgF,gBAAkB;;IAC1BhF,uBAAAA,YAAAA,SAAQiF,kDAARjF,UAAQiF,oBAAsB;;IAC9BjF,oBAAAA,YAAAA,SAAQwG,4CAARxG,UAAQwG,iBAAmB;;IAC3BxG,2BAAAA,YAAAA,SAAQmF,0DAARnF,UAAQmF,wBAA0B;;IAClCnF,yBAAAA,YAAAA,SAAQyF,sDAARzF,UAAQyF,sBAAwB;IAChC,OAAOzF;AACT;AAEA,SAASoB,iCACPc,WAAmB,EACnBjC,OAAkD;IAElD,wEAAwE;IACxE,MAAMkC,eAAeC,IAAAA,eAAW,EAAC9B,IAAAA,UAAI,EAACL,QAAQwB,aAAa,EAAES;IAC7D,IACE,CAACC,aAAaiB,QAAQ,CAAC,mBACvB,CAACjB,aAAaiB,QAAQ,CAAC,iBACvB;QACA,OAAO;IACT;IAEA,OAAO;AACT"}